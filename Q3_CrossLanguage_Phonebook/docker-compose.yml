services:
  # Python gRPC Database Server
  python-db-server:
    build: 
      context: ./python-database-server
      dockerfile: Dockerfile
    container_name: phonebook-python-db
    ports:
      - "50051:50051"
    networks:
      - phonebook-network
    healthcheck:
      test: ["CMD", "python", "-c", "import socket; s=socket.socket(); s.connect(('localhost', 50051)); s.close()"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    environment:
      - PYTHONUNBUFFERED=1

  # Java Spring Boot Web Server
  java-web-server:
    build:
      context: ./java-web-server  
      dockerfile: Dockerfile
    container_name: phonebook-java-web
    ports:
      - "8080:8080"
    depends_on:
      python-db-server:
        condition: service_healthy
    networks:
      - phonebook-network
    environment:
      - GRPC_SERVER_HOST=python-db-server
      - GRPC_SERVER_PORT=50051
      - SERVER_PORT=8080
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 45s
    restart: unless-stopped

  # Python CLI Client (for testing)
  python-client:
    build:
      context: ./python-client
      dockerfile: Dockerfile
    container_name: phonebook-python-client
    depends_on:
      java-web-server:
        condition: service_healthy
    networks:
      - phonebook-network
    environment:
      - PYTHONUNBUFFERED=1
      - GRPC_SERVER_HOST=python-db-server
      - GRPC_SERVER_PORT=50051
    # Don't auto-start the client, run it manually when needed
    profiles:
      - manual
    restart: "no"

# Custom network for inter-container communication
networks:
  phonebook-network:
    driver: bridge
    name: phonebook-net

# Volumes for data persistence (optional)
volumes:
  phonebook-data:
    driver: local